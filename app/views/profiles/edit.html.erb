<turbo-frame id="modal">
  <div class="modal-backdrop" data-controller="modal" data-action="click->modal#close">
    <div class="modal-content max-w-2xl" data-action="click->modal#stopPropagation">
      <div class="modal-header">
        <h2 class="modal-title">
          <% if params[:section] == "password" %>
            <%= t("profile.password.change") %>
          <% else %>
            <%= t("profile.avatar.change") %>
          <% end %>
        </h2>
        <button class="modal-close" data-action="click->modal#close" type="button">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <%= form_with model: @user, url: profile_path, method: :patch, data: { controller: "avatar-crop" } do |f| %>
        <div class="modal-body">
          <% if params[:section] == "password" %>
            <!-- Password Change Form -->
            <div class="space-y-4">
              <p class="text-sm text-dark-text-muted"><%= t("profile.password.change_description") %></p>
              
              <div class="form-group">
                <%= f.label :password, t("profile.password.new_password"), class: "form-label" %>
                <%= f.password_field :password, class: "input", placeholder: t("profile.password.enter_new") %>
              </div>

              <div class="form-group">
                <%= f.label :password_confirmation, t("profile.password.confirm_password"), class: "form-label" %>
                <%= f.password_field :password_confirmation, class: "input", placeholder: t("profile.password.confirm_new") %>
              </div>

              <div class="bg-warning/10 border border-warning/30 rounded-lg p-4">
                <p class="text-sm text-warning"><%= t("profile.password.warning") %></p>
              </div>
            </div>

          <% else %>
            <!-- Avatar Upload Form -->
            <div class="space-y-4">
              <p class="text-sm text-dark-text-muted"><%= t("profile.avatar.upload_description") %></p>
              
              <div class="form-group">
                <%= f.label :avatar, t("profile.avatar.select_image"), class: "form-label" %>
                <%= f.file_field :avatar, accept: "image/*", class: "input", data: { action: "change->avatar-crop#loadImage", avatar_crop_target: "fileInput" } %>
                <p class="text-xs text-dark-text-muted mt-1"><%= t("profile.avatar.size_note") %></p>
              </div>

              <!-- Image Preview and Crop -->
              <div data-avatar-crop-target="cropContainer" class="hidden">
                <label class="form-label"><%= t("profile.avatar.adjust") %></label>
                <div class="bg-dark-surface rounded-lg p-4">
                  <div class="max-w-full overflow-hidden">
                    <img data-avatar-crop-target="image" class="max-w-full" style="max-height: 400px;">
                  </div>
                </div>
                <input type="hidden" name="cropped_avatar" data-avatar-crop-target="croppedData">
              </div>
            </div>
          <% end %>

          <% if @user.errors.any? %>
            <div class="alert alert-error mt-4">
              <ul class="list-disc list-inside">
                <% @user.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="click->modal#close">
            <%= t("common.cancel") %>
          </button>
          <%= f.submit t("common.save"), class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</turbo-frame>
