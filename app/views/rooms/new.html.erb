<turbo-frame id="modal">
  <div class="modal-backdrop" data-controller="modal" data-action="click->modal#closeOnBackdrop keydown@window->modal#closeOnEscape">
    <div class="modal" data-modal-target="content">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold">
          <% case @room.room_type %>
          <% when "personal_chat" %>
            <%= t("rooms.new.title_chat") %>
          <% when "group" %>
            <%= t("rooms.new.title_group") %>
          <% when "channel" %>
            <%= t("rooms.new.title_channel") %>
          <% end %>
        </h2>
        <%= link_to rooms_path, class: "btn-icon btn-ghost", data: { turbo_frame: "modal" } do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        <% end %>
      </div>

      <%= form_with model: @room, class: "space-y-4", multipart: true do |f| %>
        <%= f.hidden_field :room_type %>

        <% if @room.errors.any? %>
          <div class="p-4 rounded-lg bg-error/20 text-error border border-error/30 text-sm">
            <ul class="list-disc list-inside space-y-1">
              <% @room.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <% if @room.personal_chat? %>
          <div>
            <label class="label"><%= t("participants.add") %></label>
            <input type="text" name="user_id" class="input" placeholder="@username" required>
          </div>
        <% else %>
          <div>
            <%= f.label :image, t("rooms.image"), class: "label" %>
            <%= f.file_field :image, accept: "image/*", class: "input" %>
            <p class="text-xs text-dark-text-muted mt-1"><%= t("rooms.image_description") %></p>
          </div>

          <div data-controller="handle">
            <%= f.label :handle, "@#{t('rooms.handle')}", class: "label" %>
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-dark-text-muted">@</span>
              <%= f.text_field :handle, 
                  class: "input pl-8", 
                  placeholder: "group_name", 
                  required: true, 
                  autofocus: true, 
                  minlength: 3, 
                  maxlength: 50,
                  data: { 
                    handle_target: "input",
                    action: "input->handle#validate"
                  } %>
            </div>
            <p class="text-xs text-dark-text-muted mt-1"><%= t('rooms.handle_required') %></p>
            <p class="text-xs text-error mt-1 hidden" data-handle-target="error">
              <%= t('rooms.handle_latin_only') %>
            </p>
          </div>
          
          <div>
            <%= f.label :name, class: "label" %>
            <%= f.text_field :name, class: "input", required: true %>
          </div>

          <div>
            <%= f.label :description, class: "label" %>
            <%= f.text_area :description, class: "input", rows: 3 %>
          </div>

          <% if @room.channel? %>
            <div>
              <%= f.label :visibility, class: "label" %>
              <%= f.select :visibility, [
                [t("rooms.visibility.private"), "private_room"],
                [t("rooms.visibility.public"), "public_room"]
              ], {}, class: "input" %>
            </div>
          <% end %>
        <% end %>

        <div class="flex gap-3 pt-4">
          <%= link_to t("common.cancel"), rooms_path, class: "btn btn-secondary flex-1", data: { turbo_frame: "modal" } %>
          <%= f.submit t("common.save"), class: "btn btn-primary flex-1" %>
        </div>
      <% end %>
    </div>
  </div>
</turbo-frame>
