<%= turbo_frame_tag dom_id(message) do %>
  <div class="message <%= message.user == current_user ? 'message-own' : 'message-other' %>" id="<%= dom_id(message) %>">
    <% unless message.user == current_user %>
      <div class="avatar avatar-sm flex-shrink-0 mt-auto">
        <% if message.user.avatar.attached? %>
          <%= image_tag message.user.avatar, alt: message.user.username %>
        <% else %>
          <%= message.user.username[0].upcase %>
        <% end %>
      </div>
    <% end %>
    
    <div class="flex flex-col gap-2 <%= (message.room.channel? || message.room.group?) ? 'w-full' : 'max-w-[70%]' %>">
      <div class="message-bubble group relative">
        <% unless message.user == current_user || message.room.personal_chat? %>
          <div class="text-xs font-medium text-primary mb-1"><%= message.user.username %></div>
        <% end %>
        
        <% if message.deleted? %>
          <p class="message-deleted"><%= t("messages.deleted") %></p>
        <% else %>
          <% if message.image.attached? %>
            <div class="mb-2">
              <%= link_to rails_blob_path(message.image, disposition: "attachment"), target: "_blank", class: "block" do %>
                <%= image_tag message.image.variant(resize_to_limit: [400, 400]), class: "rounded-lg max-w-full h-auto" %>
              <% end %>
            </div>
          <% end %>
          
          <% if message.content.present? %>
            <p class="whitespace-pre-wrap break-words"><%= message.content %></p>
          <% end %>
          
          <div class="message-time flex items-center gap-1 justify-end">
            <span><%= l(message.created_at, format: :message) %></span>
            <% if message.edited? %>
              <span class="text-xs opacity-70">(<%= t("messages.edited") %>)</span>
            <% end %>
            <% if message.user == current_user %>
              <%= render "messages/status_icon", message: message %>
            <% end %>
          </div>
        <% end %>
        
        <% if message.user == current_user && !message.deleted? %>
          <div class="absolute -left-8 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
            <%= button_to room_message_path(message.room, message), method: :delete, class: "btn-icon btn-ghost p-1", data: { turbo_confirm: t("common.confirm") } do %>
              <svg class="w-4 h-4 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <% if message.reactions_allowed? && !message.deleted? %>
        <!-- Reactions section -->
        <div class="flex flex-wrap gap-1 mt-2" id="reactions-<%= message.id %>">
          <%= render "reactions/reactions_list", message: message %>
        </div>
      <% end %>
      
      <% if message.comments_allowed? && !message.deleted? %>
        <!-- Comments section -->
        <div class="ml-4 space-y-1">
          <% if message.comments_count > 0 %>
            <button type="button" 
                    onclick="document.getElementById('comments-<%= message.id %>').classList.toggle('hidden')" 
                    class="text-xs text-primary hover:underline flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
              <%= message.comments_count %> <%= message.comments_count == 1 ? 'комментарий' : 'комментария' %>
            </button>
          <% else %>
            <button type="button" 
                    onclick="document.getElementById('comments-<%= message.id %>').classList.toggle('hidden')" 
                    class="text-xs text-dark-text-muted hover:text-primary transition-colors flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
              Комментировать
            </button>
          <% end %>
          
          <div id="comments-<%= message.id %>" class="hidden mt-2 space-y-2">
            <div id="comments-list-<%= message.id %>">
              <%= render partial: "comments/comment", collection: message.comments.not_deleted.chronological, as: :comment %>
            </div>
            <%= render "comments/form", message: message %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
